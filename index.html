<html>

    <head>
        <title>Gravitating Grains Game</title>

        <link href="https://fonts.googleapis.com/css?family=Freckle+Face" rel="stylesheet">
        <link rel="stylesheet" href="./css/main.css" media="screen" title="no title" charset="utf-8">

        <script src="./grain.js"></script>
        <script type="text/javascript">

        // Default Particle Pen
        let particleSelectionString = "sand";
        let particleSize = 15;

        window.onload = function () {
            let canvas = document.getElementById("myCanvas");

            grainbox = new Grainbox(canvas);

            penX = -1;
            penY = -1;
            oldPenX = -1;
            oldPenY = -1;
            mouseIsDown = false;

            canvas.addEventListener("mousedown", mouseDown);
            canvas.addEventListener("mouseup", mouseUp);
            canvas.addEventListener("mousemove", mouseMove);

            window.requestAnimationFrame(draw);
        }


        function mouseDown(event) {
            let x = event.x;
            let y = event.y;

            let canvas = document.getElementById("myCanvas");

            x -= canvas.getBoundingClientRect().left;
            y -= canvas.getBoundingClientRect().top;

            penX = x;
            penY = y;

            mouseIsDown = true;
        }

        function mouseUp(event) {
            penX = -1;
            penY = -1;

            mouseIsDown = false;
        }

        function mouseMove(event) {
            let x = event.x;
            let y = event.y;

            let canvas = document.getElementById("myCanvas");

            x -= canvas.getBoundingClientRect().left;
            y -= canvas.getBoundingClientRect().top;

            penX = x;
            penY = y;
        }
        
        function particleSelection(obj) {
            switch (obj.id) {
                case "empty":
                    particleSelectionString = "empty";
                    break;
                case "sand":
                    particleSelectionString = "sand";
                    break;
                case "wall":
                    particleSelectionString = "wall";
                    break;
                case "fire":
                    particleSelectionString = "fire";
                    break;
                case "water":
                    particleSelectionString = "water";
                    break;
                case "steam":
                    particleSelectionString = "steam";
                    break;
                case "oil":
                    particleSelectionString = "oil";
                    break;
                case "plant":
                    particleSelectionString = "plant";
                    break;
            }
        }
        
        function sizeSelection(obj) {
            particleSize = obj.id;
        }
        
        function erase() {
            grainbox.erase();
        }

        function draw() {

            grainbox.update();

            let canvas = document.getElementById("myCanvas");
            let ctx = canvas.getContext("2d");
            ctx.putImageData(grainbox.imageData, 0, 0);

            let penSize = particleSize;

            if (mouseIsDown) {
                let particleType = ParticleType[particleSelectionString.toUpperCase()];
                grainbox.pen = particleType;
                let color = particleType.toString(16);
                while (color.length < 6) {
                    // Put zeroes before if less than 6 digits (hexadecimal color value)
                    color = "0" + color;
                }
                ctx.strokeStyle = "#" + color;

                ctx.lineCap = "round";
                ctx.lineWidth = penSize;
                ctx.beginPath();
                if (oldPenX == -1 && oldPenY == -1) {
                    ctx.moveTo(penX, penY);
                } else {
                    ctx.moveTo(oldPenX, oldPenY);
                }
                ctx.lineTo(penX, penY);
                ctx.stroke();

                grainbox.setImageData(ctx.getImageData(0, 0, canvas.width, canvas.height));
            }

            oldPenX = penX;
            oldPenY = penY;

            window.requestAnimationFrame(draw);
        }
        </script>
    </head>

    <body>
        <h1>Gary's Groovy Gravitating Grains Game</h1>
        <main>

            <div class="buttons">
                <button class="wall-button" id="wall" onclick="particleSelection(this)">Wall</button>
                <button class="eraser-button" id="empty" onclick="particleSelection(this)">Eraser</button>
                <button class="sand-button" id="sand" onclick="particleSelection(this)">Sand</button>
                <button class="water-button" id="water" onclick="particleSelection(this)">Water</button>
                <button class="steam-button" id="steam" onclick="particleSelection(this)">Steam</button>
                <button class="oil-button" id="oil" onclick="particleSelection(this)">Oil</button>
                <button class="plant-button" id="plant" onclick="particleSelection(this)">Plant</button>
                <button class="fire-button" id="fire" onclick="particleSelection(this)">Fire</button>
                <br>
                <button class="spout-button" id="spout" onclick="particleSelection(this)">Spout</button>
                <button class="torch-button" id="torch" onclick="particleSelection(this)">Torch</button>
            </div>
            
            <canvas id="myCanvas" width="700" height="420"></canvas>

            <div class="buttons">
                <button>Gravity</button>
                <button onclick="save()">Save</button>
                <button onclick="erase()">Reset</button>
                <br>
                <button class="large-pen-button" id="42" onclick="sizeSelection(this)">Large</button>
                <button class="medium-pen-button" id="15" onclick="sizeSelection(this)">Medium</button>
                <button class="small-pen-button" id="5" onclick="sizeSelection(this)">Small</button>
                <br>
                <button>About</button>
            </div>

        </main>

    </body>

</html>